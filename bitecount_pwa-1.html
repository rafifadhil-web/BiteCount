<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BiteCount - Manajemen Kalori Anda</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Rajdhani', sans-serif;
            background: linear-gradient(135deg, #0F172A 0%, #1E293B 100%);
            color: #E2E8F0;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Loading Animation */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #0F172A;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s, visibility 0.5s;
        }

        .loading-screen.hidden {
            opacity: 0;
            visibility: hidden;
        }

        .leaf-spinner {
            width: 60px;
            height: 60px;
            position: relative;
            animation: spin 2s linear infinite;
        }

        .leaf-spinner i {
            font-size: 60px;
            color: #06B6D4;
            text-shadow: 0 0 20px #06B6D4;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Glassmorphism Cards */
        .glass-card {
            background: rgba(30, 41, 59, 0.6);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(6, 182, 212, 0.3);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }

        .glass-card:hover {
            border-color: rgba(6, 182, 212, 0.6);
            box-shadow: 0 0 30px rgba(6, 182, 212, 0.2);
        }

        /* Neon Button */
        .neon-btn {
            background: linear-gradient(135deg, #06B6D4, #8B5CF6);
            border: none;
            border-radius: 12px;
            color: white;
            font-weight: 600;
            padding: 12px 24px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 0 20px rgba(139, 92, 246, 0.4);
            position: relative;
            overflow: hidden;
        }

        .neon-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 0 30px rgba(139, 92, 246, 0.6);
        }

        .neon-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .neon-btn:active::before {
            width: 300px;
            height: 300px;
        }

        /* Floating Action Button */
        .fab {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #8B5CF6, #06B6D4);
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(139, 92, 246, 0.6);
            z-index: 1000;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        /* Progress Ring */
        .progress-ring {
            position: relative;
            width: 200px;
            height: 200px;
            margin: 0 auto;
        }

        .progress-ring__circle {
            transition: stroke-dashoffset 0.5s ease;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }

        .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .progress-text h2 {
            font-size: 2.5rem;
            font-weight: 700;
            color: #06B6D4;
            text-shadow: 0 0 10px rgba(6, 182, 212, 0.5);
        }

        /* Macro Cards */
        .macro-card {
            background: linear-gradient(135deg, rgba(6, 182, 212, 0.2), rgba(139, 92, 246, 0.2));
            border: 1px solid rgba(6, 182, 212, 0.4);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .macro-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(6, 182, 212, 0.3);
        }

        .macro-icon {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        /* Search Bar */
        .search-bar {
            background: rgba(30, 41, 59, 0.8);
            border: 2px solid rgba(6, 182, 212, 0.3);
            border-radius: 12px;
            padding: 12px 20px;
            color: #E2E8F0;
            width: 100%;
            transition: all 0.3s ease;
        }

        .search-bar:focus {
            outline: none;
            border-color: #06B6D4;
            box-shadow: 0 0 20px rgba(6, 182, 212, 0.3);
        }

        /* Food List */
        .food-item {
            background: rgba(30, 41, 59, 0.5);
            border-left: 3px solid #8B5CF6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .food-item:hover {
            background: rgba(30, 41, 59, 0.8);
            transform: translateX(5px);
        }

        /* Toast Notification */
        .toast-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #10B981, #06B6D4);
            color: white;
            padding: 15px 20px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(16, 185, 129, 0.4);
            z-index: 9999;
            animation: slideIn 0.3s ease;
            display: none;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Modal Custom */
        .modal-content {
            background: #1E293B;
            border: 1px solid rgba(6, 182, 212, 0.3);
            border-radius: 16px;
        }

        .modal-header {
            border-bottom: 1px solid rgba(6, 182, 212, 0.2);
        }

        .modal-footer {
            border-top: 1px solid rgba(6, 182, 212, 0.2);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
        }

        .empty-state i {
            font-size: 80px;
            color: #8B5CF6;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        /* Back Button */
        .back-btn {
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid rgba(6, 182, 212, 0.3);
            border-radius: 8px;
            color: #06B6D4;
            padding: 8px 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .back-btn:hover {
            background: rgba(6, 182, 212, 0.2);
            border-color: #06B6D4;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .sticky-header {
            position: sticky;
            top: 0;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(10px);
            z-index: 100;
            padding: 15px 0;
            border-bottom: 1px solid rgba(6, 182, 212, 0.2);
        }

        /* Chatbot Styles */
        .chat-message {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            flex-shrink: 0;
        }

        .bot-message .message-avatar {
            background: linear-gradient(135deg, #06B6D4, #8B5CF6);
        }

        .user-message {
            flex-direction: row-reverse;
        }

        .user-message .message-avatar {
            background: linear-gradient(135deg, #8B5CF6, #EC4899);
        }

        .message-content {
            background: rgba(30, 41, 59, 0.6);
            border: 1px solid rgba(6, 182, 212, 0.3);
            border-radius: 12px;
            padding: 12px 16px;
            max-width: 70%;
        }

        .user-message .message-content {
            background: rgba(139, 92, 246, 0.3);
            border-color: rgba(139, 92, 246, 0.5);
        }

        .message-content strong {
            color: #06B6D4;
            display: block;
            margin-bottom: 5px;
        }

        .message-content p {
            margin: 5px 0;
            line-height: 1.6;
        }

        .quick-reply-btn {
            background: rgba(6, 182, 212, 0.2);
            border: 1px solid rgba(6, 182, 212, 0.4);
            border-radius: 20px;
            padding: 6px 12px;
            margin: 5px 5px 5px 0;
            color: #06B6D4;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            display: inline-block;
        }

        .quick-reply-btn:hover {
            background: rgba(6, 182, 212, 0.4);
            transform: translateY(-2px);
        }

        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 10px;
        }

        .typing-indicator span {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #06B6D4;
            animation: typing 1.4s infinite;
        }

        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
                opacity: 0.7;
            }
            30% {
                transform: translateY(-10px);
                opacity: 1;
            }
        }

        .food-recommendation {
            background: rgba(6, 182, 212, 0.1);
            border-left: 3px solid #06B6D4;
            border-radius: 8px;
            padding: 10px;
            margin: 10px 0;
        }

        .food-recommendation strong {
            color: #06B6D4;
        }

        /* Upload Area */
        .upload-area {
            border: 2px dashed #06B6D4;
            border-radius: 10px;
            padding: 40px 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .upload-area:hover {
            border-color: #8B5CF6;
            background: rgba(139, 92, 246, 0.1);
        }

        .file-preview {
            background: rgba(30, 41, 59, 0.8);
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            border: 1px solid rgba(6, 182, 212, 0.3);
        }

        .file-preview img {
            max-width: 200px;
            max-height: 150px;
            border-radius: 8px;
            border: 2px solid #06B6D4;
        }

        /* Profile Picture Styles */
        .profile-picture {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #06B6D4;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .profile-picture:hover {
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(6, 182, 212, 0.5);
        }

        .profile-picture-lg {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid #06B6D4;
        }

        .profile-info {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .profile-details {
            flex: 1;
        }

        .profile-badge {
            display: inline-block;
            background: linear-gradient(135deg, #8B5CF6, #EC4899);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-top: 5px;
        }

        .edit-profile-btn {
            background: rgba(6, 182, 212, 0.2);
            border: 1px solid rgba(6, 182, 212, 0.4);
            border-radius: 8px;
            color: #06B6D4;
            padding: 6px 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .edit-profile-btn:hover {
            background: rgba(6, 182, 212, 0.4);
            transform: translateY(-2px);
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="leaf-spinner">
            <i class="fas fa-leaf"></i>
        </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast-notification" id="toast"></div>

    <!-- Page: Welcome -->
    <div class="page active" id="welcomePage">
        <div class="container py-5">
            <div class="text-center mb-5">
                <h1 class="display-3 fw-bold mb-3" style="color: #06B6D4; text-shadow: 0 0 20px rgba(6, 182, 212, 0.5);">
                    <i class="fas fa-leaf"></i> BiteCount
                </h1>
                <p class="lead">Track Your Journey to Better Health</p>
            </div>

            <div class="row justify-content-center">
                <div class="col-lg-6">
                    <div class="glass-card">
                        <h3 class="mb-4 text-center">Setup Profil Anda</h3>
                        <form id="profileForm">
                            <div class="mb-3">
                                <label class="form-label">Nama</label>
                                <input type="text" class="search-bar" id="userName" required placeholder="Masukkan nama Anda">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Jenis Kelamin</label>
                                <select class="search-bar" id="gender" required>
                                    <option value="">Pilih</option>
                                    <option value="male">Pria</option>
                                    <option value="female">Wanita</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Usia (tahun)</label>
                                <input type="number" class="search-bar" id="age" required placeholder="25">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Tinggi Badan (cm)</label>
                                <input type="number" class="search-bar" id="height" required placeholder="170">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Berat Badan (kg)</label>
                                <input type="number" class="search-bar" id="weight" required placeholder="70">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Tingkat Aktivitas</label>
                                <select class="search-bar" id="activity" required>
                                    <option value="">Pilih</option>
                                    <option value="1.2">Sangat Ringan (tidak olahraga)</option>
                                    <option value="1.375">Ringan (1-3x/minggu)</option>
                                    <option value="1.55">Sedang (3-5x/minggu)</option>
                                    <option value="1.725">Berat (6-7x/minggu)</option>
                                    <option value="1.9">Sangat Berat (2x sehari)</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Target</label>
                                <select class="search-bar" id="goal" required>
                                    <option value="">Pilih</option>
                                    <option value="deficit">Turunkan Berat (Deficit)</option>
                                    <option value="maintain">Pertahankan Berat</option>
                                    <option value="surplus">Naikkan Berat (Surplus)</option>
                                </select>
                            </div>
                            <button type="submit" class="neon-btn w-100 mt-4">
                                <i class="fas fa-rocket"></i> Mulai Perjalanan
                            </button>
                        </form>

                        <!-- Chatbot Button di Welcome Page -->
                        <div class="text-center mt-4">
                            <button class="neon-btn" onclick="showWelcomeChatbot()" style="background: linear-gradient(135deg, #10B981, #06B6D4);">
                                <i class="fas fa-robot"></i> Tanya NutriBot AI
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Page: Dashboard -->
    <div class="page" id="dashboardPage">
        <div class="sticky-header">
            <div class="container">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">BiteCount</h5>
                    <button class="back-btn" onclick="showSettings()">
                        <i class="fas fa-cog"></i>
                    </button>
                </div>
            </div>
        </div>

        <div class="container py-4">
            <!-- Profil User Section -->
            <div class="glass-card mb-4">
                <div class="profile-info">
                    <div class="position-relative">
                        <img id="userProfileImage" 
                             src="https://ui-avatars.com/api/?name=User&background=06B6D4&color=fff&size=128" 
                             class="profile-picture"
                             onclick="showEditProfileModal()">
                        <span class="position-absolute bottom-0 end-0 bg-success border border-2 border-dark rounded-circle" 
                              style="width: 12px; height: 12px;"></span>
                    </div>
                    <div class="profile-details">
                        <h4 class="mb-1" id="displayName">User</h4>
                        <div class="d-flex align-items-center gap-2">
                            <span class="profile-badge" id="userGoalBadge">Target: Turunkan Berat</span>
                            <button class="edit-profile-btn" onclick="showEditProfileModal()">
                                <i class="fas fa-edit"></i> Edit Profil
                            </button>
                        </div>
                        <p class="text-muted small mb-0 mt-2" id="userBio">Belum ada bio</p>
                    </div>
                </div>
                
                <div class="progress-ring mb-4">
                    <svg width="200" height="200">
                        <circle cx="100" cy="100" r="90" fill="none" stroke="rgba(30, 41, 59, 0.5)" stroke-width="15"/>
                        <circle id="progressCircle" cx="100" cy="100" r="90" fill="none" stroke="#06B6D4" stroke-width="15" 
                                stroke-linecap="round" stroke-dasharray="565.48" stroke-dashoffset="565.48"/>
                    </svg>
                    <div class="progress-text">
                        <h2 id="remainingCalories">0</h2>
                        <small>kkal tersisa</small>
                    </div>
                </div>

                <div class="row g-3 mb-3">
                    <div class="col-4">
                        <div class="macro-card">
                            <div class="macro-icon">ü•©</div>
                            <div><strong id="proteinValue">0</strong>g</div>
                            <small>Protein</small>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="macro-card">
                            <div class="macro-icon">üçö</div>
                            <div><strong id="carbValue">0</strong>g</div>
                            <small>Karbo</small>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="macro-card">
                            <div class="macro-icon">ü•ë</div>
                            <div><strong id="fatValue">0</strong>g</div>
                            <small>Lemak</small>
                        </div>
                    </div>
                </div>
            </div>

            <div class="glass-card mb-4">
                <input type="text" class="search-bar" id="searchFood" placeholder="üîç Makan apa hari ini?">
                <div id="searchResults" class="mt-3"></div>
            </div>

            <div class="glass-card">
                <h5 class="mb-3">Riwayat Hari Ini</h5>
                <div id="foodHistory">
                    <div class="empty-state">
                        <i class="fas fa-utensils"></i>
                        <h5>Perut masih kosong nih?</h5>
                        <p>Yuk catat makananmu hari ini!</p>
                    </div>
                </div>
            </div>
        </div>

        <button class="fab" onclick="showAddFoodModal()">
            <i class="fas fa-plus"></i>
        </button>

        <!-- Chatbot Button -->
        <button class="fab" style="bottom: 100px; background: linear-gradient(135deg, #10B981, #06B6D4);" onclick="showChatbot()">
            <i class="fas fa-robot"></i>
        </button>
    </div>

    <!-- Page: Chatbot -->
    <div class="page" id="chatbotPage">
        <div class="container py-4" style="max-width: 800px;">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h4><i class="fas fa-robot"></i> NutriBot AI</h4>
                <button class="back-btn" onclick="closeChatbot()">
                    <i class="fas fa-times"></i> Tutup
                </button>
            </div>

            <div class="glass-card mb-3" style="height: 60vh; overflow-y: auto; padding: 20px;" id="chatContainer">
                <div class="chat-message bot-message">
                    <div class="message-avatar">ü§ñ</div>
                    <div class="message-content">
                        <strong>NutriBot</strong>
                        <p>Halo! Saya NutriBot, asisten nutrisi pintar Anda! üåü</p>
                        <p>Saya bisa membantu:</p>
                        <ul style="margin: 10px 0; padding-left: 20px;">
                            <li>üì∏ <strong>Analisis gambar</strong> makanan</li>
                            <li>üìÑ <strong>Analisis dokumen</strong> label nutrisi</li>
                            <li>üí° Rekomendasi makanan sesuai target</li>
                            <li>üî¢ Menghitung kalori dalam makanan</li>
                            <li>ü•ó Saran menu harian yang seimbang</li>
                        </ul>
                        <p>Coba fitur upload:</p>
                        <div style="margin-top: 10px;">
                            <button class="quick-reply-btn" onclick="showImageUploadModal()">
                                <i class="fas fa-image"></i> Upload Gambar Makanan
                            </button>
                            <button class="quick-reply-btn" onclick="showDocumentUpload()">
                                <i class="fas fa-file-alt"></i> Upload Dokumen
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="glass-card">
                <div class="d-flex gap-2">
                    <button class="btn btn-sm btn-outline-info" onclick="showImageUploadModal()" title="Upload File">
                        <i class="fas fa-paperclip"></i>
                    </button>
                    <input type="text" class="search-bar" id="chatInput" placeholder="Ketik pertanyaan atau upload file..." style="flex: 1;">
                    <button class="neon-btn" onclick="sendMessage()" style="padding: 12px 20px;">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Page: Settings -->
    <div class="page" id="settingsPage">
        <div class="container py-4">
            <button class="back-btn mb-4" onclick="showDashboard()">
                <i class="fas fa-arrow-left"></i> Kembali
            </button>

            <div class="glass-card">
                <h4 class="mb-4">Pengaturan Profil</h4>
                <div class="profile-info mb-4">
                    <img id="settingsProfileImage" 
                         src="https://ui-avatars.com/api/?name=User&background=06B6D4&color=fff&size=128" 
                         class="profile-picture-lg">
                    <div class="profile-details">
                        <h5 id="settingsUserName">User</h5>
                        <p class="text-muted" id="settingsUserEmail">user@example.com</p>
                        <button class="edit-profile-btn" onclick="showEditProfileModal()">
                            <i class="fas fa-edit"></i> Edit Profil
                        </button>
                    </div>
                </div>
                <div class="mb-3">
                    <strong>Target Kalori Harian:</strong> <span id="settingCalories">0</span> kkal
                </div>
                <div class="mb-3">
                    <strong>BMR:</strong> <span id="settingBMR">0</span> kkal
                </div>
                <div class="mb-3">
                    <strong>TDEE:</strong> <span id="settingTDEE">0</span> kkal
                </div>
                <button class="neon-btn w-100 mt-3" onclick="resetApp()">
                    <i class="fas fa-redo"></i> Reset Data
                </button>
            </div>
        </div>
    </div>

    <!-- Modal: Add Food -->
    <div class="modal fade" id="addFoodModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Tambah Makanan</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Nama Makanan</label>
                        <input type="text" class="search-bar" id="foodName" placeholder="Contoh: Nasi Goreng">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Kalori (kkal)</label>
                        <input type="number" class="search-bar" id="foodCalories" placeholder="300">
                    </div>
                    <div class="row">
                        <div class="col-4">
                            <label class="form-label">Protein (g)</label>
                            <input type="number" class="search-bar" id="foodProtein" placeholder="10">
                        </div>
                        <div class="col-4">
                            <label class="form-label">Karbo (g)</label>
                            <input type="number" class="search-bar" id="foodCarb" placeholder="45">
                        </div>
                        <div class="col-4">
                            <label class="form-label">Lemak (g)</label>
                            <input type="number" class="search-bar" id="foodFat" placeholder="8">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="button" class="neon-btn" onclick="addFood()">Tambahkan</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Welcome Chatbot -->
    <div class="modal fade" id="welcomeChatbotModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-robot"></i> NutriBot AI</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" style="height: 500px; overflow: hidden;">
                    <div class="glass-card" style="height: 400px; overflow-y: auto; margin-bottom: 10px;" id="welcomeChatContainer">
                        <div class="chat-message bot-message">
                            <div class="message-avatar">ü§ñ</div>
                            <div class="message-content">
                                <strong>NutriBot</strong>
                                <p>Halo! üëã Saya NutriBot, asisten nutrisi pintar Anda!</p>
                                <p>Sebelum mulai, saya bisa membantu dengan:</p>
                                <ul>
                                    <li>üí° Menjelaskan cara menghitung kebutuhan kalori</li>
                                    <li>üìä Membantu menentukan target yang realistis</li>
                                    <li>ü•ó Memberikan tips nutrisi dasar</li>
                                    <li>üì∏ Analisis foto makanan (upload gambar)</li>
                                    <li>üìÑ Analisis dokumen nutrisi</li>
                                </ul>
                                <p>Apa yang ingin Anda ketahui?</p>
                                <div style="margin-top: 10px;">
                                    <button class="quick-reply-btn" onclick="sendWelcomeQuickReply('Bagaimana cara menghitung kebutuhan kalori?')">Cara hitung kalori</button>
                                    <button class="quick-reply-btn" onclick="sendWelcomeQuickReply('Tips diet sehat untuk pemula')">Tips diet pemula</button>
                                    <button class="quick-reply-btn" onclick="showImageUploadModal()">üì∏ Upload foto makanan</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="glass-card">
                        <div class="d-flex gap-2">
                            <button class="btn btn-sm btn-outline-info" onclick="showImageUploadModal()" title="Upload Gambar">
                                <i class="fas fa-image"></i>
                            </button>
                            <input type="text" class="search-bar" id="welcomeChatInput" placeholder="Tanya tentang nutrisi..." style="flex: 1;">
                            <button class="neon-btn" onclick="sendWelcomeMessage()" style="padding: 10px 15px;">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Upload Gambar/Dokumen -->
    <div class="modal fade" id="uploadModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-file-upload"></i> Upload File</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center mb-4">
                        <div class="upload-area" id="uploadArea" 
                             style="border: 2px dashed #06B6D4; border-radius: 10px; padding: 40px 20px; cursor: pointer;">
                            <i class="fas fa-cloud-upload-alt" style="font-size: 48px; color: #06B6D4; margin-bottom: 15px;"></i>
                            <h5>Drag & Drop File</h5>
                            <p class="text-muted">atau klik untuk memilih file</p>
                            <p><small>Maksimum: 5MB per file</small></p>
                        </div>
                        <input type="file" id="fileInput" accept="image/*,.pdf,.txt,.doc,.docx,.png,.jpg,.jpeg" hidden>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Jenis Analisis:</label>
                        <select class="search-bar" id="analysisType">
                            <option value="nutrition">Analisis Nutrisi</option>
                            <option value="label">Analisis Label Makanan</option>
                            <option value="recipe">Analisis Resep</option>
                            <option value="general">Analisis Umum</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Keterangan Tambahan:</label>
                        <textarea class="search-bar" id="fileDescription" rows="2" placeholder="Deskripsi singkat..."></textarea>
                    </div>
                    
                    <div id="previewContainer" class="d-none">
                        <h6>Preview:</h6>
                        <div id="filePreview" class="file-preview"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="button" class="neon-btn" onclick="processUploadedFile()" id="uploadBtn" disabled>
                        <i class="fas fa-spinner fa-spin d-none"></i>
                        <span>Analisis File</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Edit Profile -->
    <div class="modal fade" id="editProfileModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-user-edit"></i> Edit Profil</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Foto Profil Section -->
                    <div class="text-center mb-4">
                        <div class="position-relative d-inline-block">
                            <div class="profile-picture-container" id="profilePictureContainer">
                                <img id="profileImagePreview" 
                                     src="https://ui-avatars.com/api/?name=User&background=06B6D4&color=fff&size=128" 
                                     class="profile-picture-lg"
                                     style="cursor: pointer;"
                                     onclick="document.getElementById('profileImageInput').click()">
                            </div>
                            <button class="btn btn-sm btn-info position-absolute bottom-0 end-0 rounded-circle" 
                                    style="width: 36px; height: 36px;"
                                    onclick="document.getElementById('profileImageInput').click()">
                                <i class="fas fa-camera"></i>
                            </button>
                            <input type="file" id="profileImageInput" accept="image/*" hidden>
                        </div>
                        <p class="mt-2 text-muted small">Klik foto untuk upload gambar baru</p>
                    </div>
                    
                    <!-- Form Edit Profile -->
                    <div class="mb-3">
                        <label class="form-label">Nama Lengkap</label>
                        <input type="text" class="search-bar" id="editName" placeholder="Masukkan nama Anda">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Email</label>
                        <input type="email" class="search-bar" id="editEmail" placeholder="email@anda.com">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Bio / Deskripsi</label>
                        <textarea class="search-bar" id="editBio" rows="2" placeholder="Ceritakan tentang diri Anda..."></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Tujuan Utama</label>
                        <select class="search-bar" id="editGoal">
                            <option value="deficit">Turunkan Berat Badan</option>
                            <option value="maintain">Pertahankan Berat Badan</option>
                            <option value="surplus">Naikkan Massa Otot</option>
                            <option value="health">Kesehatan Umum</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="button" class="neon-btn" onclick="saveProfile()">
                        <i class="fas fa-save"></i> Simpan Perubahan
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>
    <script>
        // Data Storage
        let userData = {};
        let foodLog = [];
        let dailyTarget = 0;
        let chatHistory = [];
        let currentChatType = 'dashboard'; // 'dashboard' or 'welcome'

        // Food Database (Makanan Lokal Indonesia)
        const foodDatabase = [
            { name: "Nasi Putih", calories: 204, protein: 4, carbs: 45, fat: 0.4, portion: "100g" },
            { name: "Nasi Goreng", calories: 333, protein: 8, carbs: 53, fat: 10, portion: "1 porsi" },
            { name: "Ayam Goreng", calories: 246, protein: 27, carbs: 0, fat: 15, portion: "1 potong" },
            { name: "Rendang", calories: 468, protein: 21, carbs: 6, fat: 40, portion: "1 porsi" },
            { name: "Gado-gado", calories: 275, protein: 11, carbs: 28, fat: 13, portion: "1 porsi" },
            { name: "Sate Ayam", calories: 210, protein: 25, carbs: 3, fat: 11, portion: "5 tusuk" },
            { name: "Tempe Goreng", calories: 192, protein: 19, carbs: 9, fat: 11, portion: "100g" },
            { name: "Tahu Goreng", calories: 76, protein: 8, carbs: 1.9, fat: 5, portion: "100g" },
            { name: "Telur Dadar", calories: 154, protein: 11, carbs: 1, fat: 12, portion: "1 butir" },
            { name: "Mie Goreng", calories: 400, protein: 12, carbs: 60, fat: 12, portion: "1 porsi" },
            { name: "Soto Ayam", calories: 220, protein: 15, carbs: 20, fat: 8, portion: "1 mangkuk" },
            { name: "Bakso", calories: 180, protein: 10, carbs: 15, fat: 9, portion: "1 mangkuk" },
            { name: "Nasi Uduk", calories: 300, protein: 6, carbs: 50, fat: 8, portion: "1 porsi" },
            { name: "Pecel Lele", calories: 350, protein: 20, carbs: 25, fat: 18, portion: "1 porsi" },
            { name: "Sayur Asem", calories: 80, protein: 3, carbs: 12, fat: 2, portion: "1 mangkuk" }
        ];

        // Initialize
        window.onload = function() {
            setTimeout(() => {
                document.getElementById('loadingScreen').classList.add('hidden');
            }, 1500);

            loadData();
            if (userData.name) {
                showDashboard();
            }
            
            // Setup profile image upload
            setupProfileImageUpload();
        };

        // Profile Setup
        document.getElementById('profileForm').addEventListener('submit', function(e) {
            e.preventDefault();
            showLoading();

            userData = {
                name: document.getElementById('userName').value,
                gender: document.getElementById('gender').value,
                age: parseInt(document.getElementById('age').value),
                height: parseInt(document.getElementById('height').value),
                weight: parseInt(document.getElementById('weight').value),
                activity: parseFloat(document.getElementById('activity').value),
                goal: document.getElementById('goal').value,
                email: "",
                bio: "",
                profileImage: "",
                goalText: getGoalText(document.getElementById('goal').value)
            };

            calculateCalories();
            saveData();

            setTimeout(() => {
                hideLoading();
                showDashboard();
                showToast('Profil berhasil disimpan!');
            }, 1000);
        });

        // Calculate BMR & TDEE
        function calculateCalories() {
            let bmr;
            if (userData.gender === 'male') {
                bmr = 10 * userData.weight + 6.25 * userData.height - 5 * userData.age + 5;
            } else {
                bmr = 10 * userData.weight + 6.25 * userData.height - 5 * userData.age - 161;
            }

            const tdee = bmr * userData.activity;

            if (userData.goal === 'deficit') {
                dailyTarget = tdee - 500;
            } else if (userData.goal === 'surplus') {
                dailyTarget = tdee + 500;
            } else {
                dailyTarget = tdee;
            }

            userData.bmr = Math.round(bmr);
            userData.tdee = Math.round(tdee);
            userData.dailyTarget = Math.round(dailyTarget);
        }

        // Get goal text
        function getGoalText(goal) {
            switch(goal) {
                case 'deficit': return 'Turunkan Berat';
                case 'maintain': return 'Pertahankan Berat';
                case 'surplus': return 'Naikkan Berat';
                default: return 'Kesehatan';
            }
        }

        // Search Food
        document.getElementById('searchFood').addEventListener('input', function(e) {
            const query = e.target.value.toLowerCase();
            const results = document.getElementById('searchResults');

            if (query.length < 2) {
                results.innerHTML = '';
                return;
            }

            const filtered = foodDatabase.filter(food => 
                food.name.toLowerCase().includes(query)
            );

            if (filtered.length > 0) {
                results.innerHTML = filtered.map(food => `
                    <div class="food-item" onclick='selectFood(${JSON.stringify(food)})'>
                        <div>
                            <strong>${food.name}</strong>
                            <div><small>${food.calories} kkal</small></div>
                        </div>
                        <i class="fas fa-plus-circle" style="color: #06B6D4;"></i>
                    </div>
                `).join('');
            } else {
                results.innerHTML = '<p class="text-center mt-3">Tidak ditemukan</p>';
            }
        });

        function selectFood(food) {
            foodLog.push({
                ...food,
                time: new Date().toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' })
            });
            saveData();
            updateDashboard();
            document.getElementById('searchFood').value = '';
            document.getElementById('searchResults').innerHTML = '';
            showToast(`${food.name} berhasil ditambahkan!`);
        }

        // Add Food Modal
        function showAddFoodModal() {
            new bootstrap.Modal(document.getElementById('addFoodModal')).show();
        }

        function addFood() {
            const name = document.getElementById('foodName').value;
            const calories = parseInt(document.getElementById('foodCalories').value);
            const protein = parseInt(document.getElementById('foodProtein').value);
            const carbs = parseInt(document.getElementById('foodCarb').value);
            const fat = parseInt(document.getElementById('foodFat').value);

            if (!name || !calories) {
                alert('Harap isi nama dan kalori makanan');
                return;
            }

            foodLog.push({
                name,
                calories,
                protein: protein || 0,
                carbs: carbs || 0,
                fat: fat || 0,
                time: new Date().toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' })
            });

            saveData();
            updateDashboard();
            bootstrap.Modal.getInstance(document.getElementById('addFoodModal')).hide();
            showToast(`${name} berhasil ditambahkan!`);

            // Reset form
            document.getElementById('foodName').value = '';
            document.getElementById('foodCalories').value = '';
            document.getElementById('foodProtein').value = '';
            document.getElementById('foodCarb').value = '';
            document.getElementById('foodFat').value = '';
        }

        // Update Dashboard
        function updateDashboard() {
            const totalCalories = foodLog.reduce((sum, food) => sum + food.calories, 0);
            const totalProtein = foodLog.reduce((sum, food) => sum + food.protein, 0);
            const totalCarbs = foodLog.reduce((sum, food) => sum + food.carbs, 0);
            const totalFat = foodLog.reduce((sum, food) => sum + food.fat, 0);

            const remaining = userData.dailyTarget - totalCalories;
            const percentage = Math.min((totalCalories / userData.dailyTarget) * 100, 100);

            // Update profile section
            document.getElementById('displayName').textContent = userData.name || 'User';
            document.getElementById('userGoalBadge').textContent = `Target: ${userData.goalText || 'Turunkan Berat'}`;
            document.getElementById('userBio').textContent = userData.bio || 'Belum ada bio';
            
            // Update profile image
            const profileImage = document.getElementById('userProfileImage');
            const settingsProfileImage = document.getElementById('settingsProfileImage');
            if (userData.profileImage) {
                profileImage.src = userData.profileImage;
                settingsProfileImage.src = userData.profileImage;
            } else {
                const name = userData.name || 'User';
                profileImage.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=06B6D4&color=fff&size=128`;
                settingsProfileImage.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=06B6D4&color=fff&size=128`;
            }

            // Update settings page
            document.getElementById('settingsUserName').textContent = userData.name || 'User';
            document.getElementById('settingsUserEmail').textContent = userData.email || 'user@example.com';
            document.getElementById('settingCalories').textContent = userData.dailyTarget || 0;
            document.getElementById('settingBMR').textContent = userData.bmr || 0;
            document.getElementById('settingTDEE').textContent = userData.tdee || 0;

            // Update calories and macros
            document.getElementById('remainingCalories').textContent = Math.max(remaining, 0);
            document.getElementById('proteinValue').textContent = totalProtein;
            document.getElementById('carbValue').textContent = totalCarbs;
            document.getElementById('fatValue').textContent = totalFat;

            // Update progress ring
            const circle = document.getElementById('progressCircle');
            const circumference = 565.48;
            const offset = circumference - (percentage / 100) * circumference;
            circle.style.strokeDashoffset = offset;

            if (totalCalories > userData.dailyTarget) {
                circle.style.stroke = '#EF4444';
            } else {
                circle.style.stroke = '#06B6D4';
            }

            // Update food history
            const historyDiv = document.getElementById('foodHistory');
            if (foodLog.length === 0) {
                historyDiv.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-utensils"></i>
                        <h5>Perut masih kosong nih?</h5>
                        <p>Yuk catat makananmu hari ini!</p>
                    </div>
                `;
            } else {
                historyDiv.innerHTML = foodLog.map((food, index) => `
                    <div class="food-item">
                        <div>
                            <strong>${food.name}</strong>
                            <div><small>${food.time} | ${food.calories} kkal</small></div>
                        </div>
                        <button class="btn btn-sm btn-danger" onclick="removeFood(${index})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `).join('');
            }
        }

        function removeFood(index) {
            const foodName = foodLog[index].name;
            foodLog.splice(index, 1);
            saveData();
            updateDashboard();
            showToast(`${foodName} dihapus`);
        }

        // Page Navigation
        function showDashboard() {
            showLoading();
            setTimeout(() => {
                document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                document.getElementById('dashboardPage').classList.add('active');
                updateDashboard();
                hideLoading();
            }, 800);
        }

        function showSettings() {
            showLoading();
            setTimeout(() => {
                document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                document.getElementById('settingsPage').classList.add('active');
                updateDashboard();
                hideLoading();
            }, 800);
        }

        // Loading
        function showLoading() {
            document.getElementById('loadingScreen').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loadingScreen').classList.add('hidden');
        }

        // Toast
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.style.display = 'block';
            setTimeout(() => {
                toast.style.display = 'none';
            }, 3000);
        }

        // Storage
        function saveData() {
            const data = {
                userData,
                foodLog,
                date: new Date().toDateString()
            };
            localStorage.setItem('biteCountData', JSON.stringify(data));
        }

        function loadData() {
            const saved = localStorage.getItem('biteCountData');
            if (saved) {
                const data = JSON.parse(saved);
                const today = new Date().toDateString();
                
                if (data.date === today) {
                    userData = data.userData;
                    foodLog = data.foodLog;
                    dailyTarget = userData.dailyTarget;
                } else {
                    userData = data.userData;
                    foodLog = [];
                    dailyTarget = userData.dailyTarget;
                    saveData();
                }
            }
        }

        function resetApp() {
            if (confirm('Yakin ingin reset semua data?')) {
                localStorage.removeItem('biteCountData');
                location.reload();
            }
        }

        // ========== PROFILE FUNCTIONS ==========

        function showEditProfileModal() {
            const modal = new bootstrap.Modal(document.getElementById('editProfileModal'));
            
            // Fill form with current data
            document.getElementById('editName').value = userData.name || '';
            document.getElementById('editEmail').value = userData.email || '';
            document.getElementById('editBio').value = userData.bio || '';
            document.getElementById('editGoal').value = userData.goal || 'deficit';
            
            // Set profile image preview
            const preview = document.getElementById('profileImagePreview');
            if (userData.profileImage) {
                preview.src = userData.profileImage;
            } else {
                const name = userData.name || 'User';
                preview.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=06B6D4&color=fff&size=128`;
            }
            
            modal.show();
        }

        function setupProfileImageUpload() {
            const profileImageInput = document.getElementById('profileImageInput');
            const profileImagePreview = document.getElementById('profileImagePreview');
            
            profileImageInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                // Check file size (max 2MB for profile picture)
                if (file.size > 2 * 1024 * 1024) {
                    alert('File terlalu besar! Maksimum 2MB untuk foto profil.');
                    return;
                }
                
                // Check file type
                if (!file.type.startsWith('image/')) {
                    alert('File harus berupa gambar!');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    profileImagePreview.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        function saveProfile() {
            const name = document.getElementById('editName').value.trim();
            const email = document.getElementById('editEmail').value.trim();
            const bio = document.getElementById('editBio').value.trim();
            const goal = document.getElementById('editGoal').value;
            
            if (!name) {
                alert('Nama tidak boleh kosong!');
                return;
            }
            
            // Update user data
            userData.name = name;
            userData.email = email;
            userData.bio = bio;
            userData.goal = goal;
            userData.goalText = getGoalText(goal);
            
            // Save profile image if changed
            const preview = document.getElementById('profileImagePreview');
            if (preview.src && !preview.src.includes('ui-avatars.com')) {
                userData.profileImage = preview.src;
            }
            
            // Recalculate calories if goal changed
            if (goal !== userData.goal) {
                userData.goal = goal;
                calculateCalories();
            }
            
            saveData();
            updateDashboard();
            bootstrap.Modal.getInstance(document.getElementById('editProfileModal')).hide();
            showToast('Profil berhasil diperbarui!');
        }

        // ========== CHATBOT FUNCTIONS ==========

        function showChatbot() {
            showLoading();
            setTimeout(() => {
                document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                document.getElementById('chatbotPage').classList.add('active');
                currentChatType = 'dashboard';
                hideLoading();
            }, 800);
        }

        function showWelcomeChatbot() {
            currentChatType = 'welcome';
            new bootstrap.Modal(document.getElementById('welcomeChatbotModal')).show();
        }

        function closeChatbot() {
            showDashboard();
        }

        function sendQuickReply(message) {
            document.getElementById('chatInput').value = message;
            sendMessage();
        }

        function sendWelcomeQuickReply(message) {
            document.getElementById('welcomeChatInput').value = message;
            sendWelcomeMessage();
        }

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;

            // Add user message
            addChatMessage('user', message);
            input.value = '';

            // Show typing indicator
            showTypingIndicator();

            // Process message with AI
            setTimeout(() => {
                hideTypingIndicator();
                const response = processAIMessage(message);
                addChatMessage('bot', response);
            }, 1500);
        }

        async function sendWelcomeMessage() {
            const input = document.getElementById('welcomeChatInput');
            const message = input.value.trim();
            
            if (!message) return;

            addWelcomeChatMessage('user', message);
            input.value = '';

            // Show typing indicator
            showWelcomeTypingIndicator();

            // Process message with AI
            setTimeout(() => {
                hideWelcomeTypingIndicator();
                const response = processWelcomeMessage(message);
                addWelcomeChatMessage('bot', response);
            }, 1500);
        }

        function addChatMessage(sender, content) {
            const chatContainer = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${sender}-message`;
            
            const avatar = sender === 'bot' ? 'ü§ñ' : (userData.name ? userData.name.charAt(0) : 'üë§');
            const name = sender === 'bot' ? 'NutriBot' : userData.name || 'Anda';
            
            messageDiv.innerHTML = `
                <div class="message-avatar">${avatar}</div>
                <div class="message-content">
                    <strong>${name}</strong>
                    ${content}
                </div>
            `;
            
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            chatHistory.push({ sender, content, timestamp: new Date() });
        }

        function addWelcomeChatMessage(sender, content) {
            const chatContainer = document.getElementById('welcomeChatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${sender}-message`;
            
            const avatar = sender === 'bot' ? 'ü§ñ' : 'üë§';
            const name = sender === 'bot' ? 'NutriBot' : 'Anda';
            
            messageDiv.innerHTML = `
                <div class="message-avatar">${avatar}</div>
                <div class="message-content">
                    <strong>${name}</strong>
                    ${content}
                </div>
            `;
            
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function showTypingIndicator() {
            const chatContainer = document.getElementById('chatContainer');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'chat-message bot-message';
            typingDiv.id = 'typingIndicator';
            typingDiv.innerHTML = `
                <div class="message-avatar">ü§ñ</div>
                <div class="message-content">
                    <div class="typing-indicator">
                        <span></span><span></span><span></span>
                    </div>
                </div>
            `;
            chatContainer.appendChild(typingDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function hideTypingIndicator() {
            const indicator = document.getElementById('typingIndicator');
            if (indicator) indicator.remove();
        }

        function showWelcomeTypingIndicator() {
            const chatContainer = document.getElementById('welcomeChatContainer');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'chat-message bot-message';
            typingDiv.id = 'welcomeTypingIndicator';
            typingDiv.innerHTML = `
                <div class="message-avatar">ü§ñ</div>
                <div class="message-content">
                    <div class="typing-indicator">
                        <span></span><span></span><span></span>
                    </div>
                </div>
            `;
            chatContainer.appendChild(typingDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function hideWelcomeTypingIndicator() {
            const indicator = document.getElementById('welcomeTypingIndicator');
            if (indicator) indicator.remove();
        }

        function processAIMessage(message) {
            const lowerMsg = message.toLowerCase();
            
            // Calculate calories in food
            if (lowerMsg.includes('berapa kalori') || lowerMsg.includes('hitung kalori') || lowerMsg.includes('kalori dalam')) {
                return calculateCaloriesResponse(message);
            }
            
            // Food recommendations
            if (lowerMsg.includes('rekomendasi') || lowerMsg.includes('saran') || lowerMsg.includes('menu')) {
                return getFoodRecommendations();
            }
            
            // Breakfast menu
            if (lowerMsg.includes('sarapan') || lowerMsg.includes('pagi')) {
                return getBreakfastMenu();
            }
            
            // Lunch menu
            if (lowerMsg.includes('makan siang') || lowerMsg.includes('siang')) {
                return getLunchMenu();
            }
            
            // Dinner menu
            if (lowerMsg.includes('makan malam') || lowerMsg.includes('malam')) {
                return getDinnerMenu();
            }
            
            // Deficit diet
            if (lowerMsg.includes('deficit') || lowerMsg.includes('diet') || lowerMsg.includes('turun')) {
                return getDeficitAdvice();
            }
            
            // Surplus diet
            if (lowerMsg.includes('surplus') || lowerMsg.includes('naik') || lowerMsg.includes('bulking')) {
                return getSurplusAdvice();
            }
            
            // Protein foods
            if (lowerMsg.includes('protein') || lowerMsg.includes('otot')) {
                return getProteinFoods();
            }
            
            // Healthy snacks
            if (lowerMsg.includes('cemilan') || lowerMsg.includes('snack')) {
                return getHealthySnacks();
            }
            
            // Upload related
            if (lowerMsg.includes('upload') || lowerMsg.includes('gambar') || lowerMsg.includes('foto') || lowerMsg.includes('dokumen')) {
                return `
                    <p>üìÅ <strong>Fitur Upload File:</strong></p>
                    <p>Saya dapat menganalisis:</p>
                    <ul>
                        <li>üñºÔ∏è <strong>Gambar makanan</strong> - estimasi kalori & nutrisi</li>
                        <li>üìÑ <strong>Dokumen label nutrisi</strong> - analisis komposisi</li>
                        <li>üìã <strong>Resep makanan</strong> - hitung nutrisi per porsi</li>
                    </ul>
                    <p>Klik tombol üìé di samping input chat untuk mengupload file!</p>
                    <button class="quick-reply-btn" onclick="showImageUploadModal()">
                        <i class="fas fa-upload"></i> Upload File Sekarang
                    </button>
                `;
            }
            
            // Default response
            return getDefaultResponse();
        }

        function processWelcomeMessage(message) {
            const lowerMsg = message.toLowerCase();
            
            // Calorie calculation explanation
            if (lowerMsg.includes('cara hitung') || lowerMsg.includes('menghitung') || lowerMsg.includes('kebutuhan kalori')) {
                return `
                    <p>üßÆ <strong>Cara Menghitung Kebutuhan Kalori:</strong></p>
                    <div class="food-recommendation">
                        <p><strong>1. BMR (Basal Metabolic Rate):</strong></p>
                        <div>‚Ä¢ Pria: (10 √ó berat kg) + (6.25 √ó tinggi cm) - (5 √ó usia) + 5</div>
                        <div>‚Ä¢ Wanita: (10 √ó berat kg) + (6.25 √ó tinggi cm) - (5 √ó usia) - 161</div>
                        
                        <p><strong>2. TDEE (Total Daily Energy Expenditure):</strong></p>
                        <div>‚Ä¢ BMR √ó tingkat aktivitas</div>
                        <div>‚Ä¢ Sangat ringan (jarang olahraga): √ó1.2</div>
                        <div>‚Ä¢ Ringan (1-3x/minggu): √ó1.375</div>
                        <div>‚Ä¢ Sedang (3-5x/minggu): √ó1.55</div>
                        <div>‚Ä¢ Berat (6-7x/minggu): √ó1.725</div>
                        <div>‚Ä¢ Sangat berat (olahraga 2x sehari): √ó1.9</div>
                        
                        <p><strong>3. Target Harian:</strong></p>
                        <div>‚Ä¢ Turun berat: TDEE - 500 kkal</div>
                        <div>‚Ä¢ Pertahankan: TDEE</div>
                        <div>‚Ä¢ Naik berat: TDEE + 500 kkal</div>
                    </div>
                    <p>Contoh: Pria 30 tahun, 70kg, 170cm, aktifitas sedang = ¬±2500 kkal/hari</p>
                `;
            }
            
            // Diet tips for beginners
            if (lowerMsg.includes('tips') || lowerMsg.includes('pemula') || lowerMsg.includes('awal')) {
                return `
                    <p>üí° <strong>Tips Diet Sehat untuk Pemula:</strong></p>
                    <div class="food-recommendation">
                        <p><strong>Prinsip Dasar:</strong></p>
                        <div>1. <strong>Konsisten</strong> lebih penting daripada sempurna</div>
                        <div>2. <strong>Minum air</strong> 2-3 liter per hari</div>
                        <div>3. <strong>Makan perlahan</strong>, kunyah dengan baik</div>
                        <div>4. <strong>Protein setiap makan</strong> untuk kenyang lebih lama</div>
                        <div>5. <strong>Sayuran</strong> setengah piring setiap makan</div>
                    </div>
                    
                    <div class="food-recommendation">
                        <p><strong>Langkah Pertama:</strong></p>
                        <div>1. Hitung kebutuhan kalori (saya bantu!)</div>
                        <div>2. Mulai tracking makanan 3 hari pertama</div>
                        <div>3. Fokus pada protein dan serat</div>
                        <div>4. Kurangi minuman manis bertahap</div>
                        <div>5. Tambahkan jalan kaki 30 menit/hari</div>
                    </div>
                    
                    <p>üéØ <strong>Target realistis:</strong> 0.5-1kg per minggu untuk penurunan berat badan yang sehat.</p>
                `;
            }
            
            // Upload related in welcome chat
            if (lowerMsg.includes('upload') || lowerMsg.includes('gambar') || lowerMsg.includes('foto')) {
                return `
                    <p>üì∏ <strong>Analisis Gambar Makanan:</strong></p>
                    <p>Saya bisa menganalisis foto makanan Anda untuk:</p>
                    <div class="food-recommendation">
                        <div>‚úÖ <strong>Estimasi kalori</strong> berdasarkan jenis makanan</div>
                        <div>‚úÖ <strong>Identifikasi nutrisi</strong> (protein, karbo, lemak)</div>
                        <div>‚úÖ <strong>Rekomendasi porsi</strong> sesuai target Anda</div>
                        <div>‚úÖ <strong>Tips modifikasi</strong> untuk versi lebih sehat</div>
                    </div>
                    <p>Cara menggunakan:</p>
                    <ol>
                        <li>Klik tombol üì∏ di bawah</li>
                        <li>Ambil foto makanan atau pilih dari galeri</li>
                        <li>Tunggu analisis 2-3 detik</li>
                        <li>Dapatkan rekomendasi nutrisi!</li>
                    </ol>
                    <button class="quick-reply-btn" onclick="showImageUploadModal()">
                        <i class="fas fa-camera"></i> Ambil/Upload Foto
                    </button>
                `;
            }
            
            // Default welcome response
            return `
                <p>Saya bisa membantu Anda memulai perjalanan nutrisi dengan:</p>
                <button class="quick-reply-btn" onclick="sendWelcomeQuickReply('Bagaimana cara menghitung kebutuhan kalori?')">
                    üßÆ Hitung Kebutuhan Kalori
                </button>
                <button class="quick-reply-btn" onclick="sendWelcomeQuickReply('Tips diet sehat untuk pemula')">
                    üí° Tips Diet Pemula
                </button>
                <button class="quick-reply-btn" onclick="showImageUploadModal()">
                    üì∏ Analisis Foto Makanan
                </button>
                <p>Atau tanyakan langsung tentang nutrisi dan diet!</p>
            `;
        }

        function calculateCaloriesResponse(message) {
            const lowerMsg = message.toLowerCase();
            let foundFood = null;
            
            // Search for food in database
            for (const food of foodDatabase) {
                if (lowerMsg.includes(food.name.toLowerCase())) {
                    foundFood = food;
                    break;
                }
            }
            
            if (foundFood) {
                return `
                    <p>Informasi nutrisi untuk <strong>${foundFood.name}</strong> (${foundFood.portion}):</p>
                    <div class="food-recommendation">
                        <div>üî• Kalori: <strong>${foundFood.calories} kkal</strong></div>
                        <div>ü•© Protein: <strong>${foundFood.protein}g</strong></div>
                        <div>üçö Karbohidrat: <strong>${foundFood.carbs}g</strong></div>
                        <div>ü•ë Lemak: <strong>${foundFood.fat}g</strong></div>
                    </div>
                    <p>Apakah Anda ingin menambahkan makanan ini ke log harian?</p>
                    <button class="quick-reply-btn" onclick="addFoodFromChat('${foundFood.name}', ${foundFood.calories}, ${foundFood.protein}, ${foundFood.carbs}, ${foundFood.fat})">
                        ‚ûï Tambah ke Log
                    </button>
                `;
            } else {
                // Extract food name from message
                const foodName = extractFoodName(message);
                return `
                    <p>Maaf, saya tidak menemukan "${foodName}" di database. Berikut estimasi kalori untuk makanan umum:</p>
                    <div class="food-recommendation">
                        <div>üçö Nasi (1 porsi): ~200 kkal</div>
                        <div>üçó Ayam (100g): ~165 kkal</div>
                        <div>ü•ö Telur (1 butir): ~70 kkal</div>
                        <div>ü•ó Sayuran (100g): ~30-50 kkal</div>
                    </div>
                    <p>Atau coba tanyakan makanan lain yang ada di database saya!</p>
                `;
            }
        }

        function extractFoodName(message) {
            const words = message.toLowerCase().split(' ');
            const stopWords = ['berapa', 'kalori', 'dalam', 'hitung', 'ada', 'di', 'untuk'];
            const foodWords = words.filter(w => !stopWords.includes(w) && w.length > 2);
            return foodWords.join(' ') || 'makanan tersebut';
        }

        function getFoodRecommendations() {
            if (!userData.dailyTarget) {
                return `<p>Silakan setup profil terlebih dahulu untuk mendapatkan rekomendasi personal!</p>`;
            }
            
            const remaining = userData.dailyTarget - foodLog.reduce((sum, f) => sum + f.calories, 0);
            const goal = userData.goal;
            
            let recommendations = [];
            
            if (goal === 'deficit') {
                recommendations = foodDatabase
                    .filter(f => f.calories < 300)
                    .sort((a, b) => a.calories - b.calories)
                    .slice(0, 5);
            } else if (goal === 'surplus') {
                recommendations = foodDatabase
                    .filter(f => f.calories > 300)
                    .sort((a, b) => b.calories - a.calories)
                    .slice(0, 5);
            } else {
                recommendations = foodDatabase.slice(0, 5);
            }
            
            let response = `<p>Berdasarkan target Anda (${goal}), berikut rekomendasi makanan:</p>`;
            response += `<p><strong>Sisa kalori hari ini: ${Math.max(remaining, 0)} kkal</strong></p>`;
            
            recommendations.forEach(food => {
                response += `
                    <div class="food-recommendation">
                        <strong>${food.name}</strong> (${food.portion})
                        <div style="margin-top: 5px;">
                            üî• ${food.calories} kkal | ü•© ${food.protein}g P | üçö ${food.carbs}g C | ü•ë ${food.fat}g F
                        </div>
                    </div>
                `;
            });
            
            return response;
        }

        function getBreakfastMenu() {
            return `
                <p>üåÖ <strong>Rekomendasi Menu Sarapan Sehat:</strong></p>
                <div class="food-recommendation">
                    <strong>Opsi 1: Sarapan Rendah Kalori</strong>
                    <div>‚Ä¢ Telur Dadar (1 butir) - 154 kkal</div>
                    <div>‚Ä¢ Tempe Goreng (50g) - 96 kkal</div>
                    <div>‚Ä¢ Nasi Putih (50g) - 102 kkal</div>
                    <div><strong>Total: ~350 kkal</strong></div>
                </div>
                <div class="food-recommendation">
                    <strong>Opsi 2: Sarapan Berprotein</strong>
                    <div>‚Ä¢ Nasi Uduk (1 porsi) - 300 kkal</div>
                    <div>‚Ä¢ Ayam Goreng (1 potong kecil) - 150 kkal</div>
                    <div>‚Ä¢ Tempe Goreng (50g) - 96 kkal</div>
                    <div><strong>Total: ~550 kkal</strong></div>
                </div>
                <p>üí° Tips: Sarapan sebaiknya 20-25% dari total kalori harian Anda!</p>
            `;
        }

        function getLunchMenu() {
            return `
                <p>‚òÄÔ∏è <strong>Rekomendasi Menu Makan Siang:</strong></p>
                <div class="food-recommendation">
                    <strong>Opsi 1: Balanced Meal</strong>
                    <div>‚Ä¢ Nasi Putih (150g) - 300 kkal</div>
                    <div>‚Ä¢ Ayam Goreng (1 potong) - 246 kkal</div>
                    <div>‚Ä¢ Sayur Asem - 80 kkal</div>
                    <div>‚Ä¢ Tempe Goreng - 192 kkal</div>
                    <div><strong>Total: ~820 kkal</strong></div>
                </div>
                <div class="food-recommendation">
                    <strong>Opsi 2: High Protein</strong>
                    <div>‚Ä¢ Nasi Putih (100g) - 204 kkal</div>
                    <div>‚Ä¢ Rendang (1 porsi) - 468 kkal</div>
                    <div>‚Ä¢ Sayuran - 80 kkal</div>
                    <div><strong>Total: ~750 kkal</strong></div>
                </div>
                <p>üí° Makan siang sebaiknya porsi terbesar, sekitar 35-40% kalori harian!</p>
            `;
        }

        function getDinnerMenu() {
            return `
                <p>üåô <strong>Rekomendasi Menu Makan Malam:</strong></p>
                <div class="food-recommendation">
                    <strong>Opsi 1: Light Dinner</strong>
                    <div>‚Ä¢ Soto Ayam (1 mangkuk) - 220 kkal</div>
                    <div>‚Ä¢ Nasi Putih (75g) - 150 kkal</div>
                    <div>‚Ä¢ Tahu Goreng - 76 kkal</div>
                    <div><strong>Total: ~450 kkal</strong></div>
                </div>
                <div class="food-recommendation">
                    <strong>Opsi 2: Protein Focus</strong>
                    <div>‚Ä¢ Pecel Lele (1 porsi) - 350 kkal</div>
                    <div>‚Ä¢ Nasi Putih (100g) - 204 kkal</div>
                    <div>‚Ä¢ Sayuran - 50 kkal</div>
                    <div><strong>Total: ~600 kkal</strong></div>
                </div>
                <p>üí° Makan malam sebaiknya lebih ringan, hindari makan 3 jam sebelum tidur!</p>
            `;
        }

        function getDeficitAdvice() {
            return `
                <p>üìâ <strong>Tips Diet Deficit Kalori:</strong></p>
                <div class="food-recommendation">
                    <strong>Prinsip Utama:</strong>
                    <div>‚Ä¢ Kurangi 300-500 kkal dari TDEE</div>
                    <div>‚Ä¢ Fokus pada makanan tinggi protein</div>
                    <div>‚Ä¢ Perbanyak sayuran untuk kenyang lebih lama</div>
                    <div>‚Ä¢ Minum air putih 2-3 liter/hari</div>
                </div>
                <div class="food-recommendation">
                    <strong>Makanan yang Disarankan:</strong>
                    <div>‚úÖ Tempe & Tahu (protein tinggi, kalori rendah)</div>
                    <div>‚úÖ Telur (kenyang lama)</div>
                    <div>‚úÖ Sayuran hijau (serat tinggi)</div>
                    <div>‚úÖ Ayam tanpa kulit</div>
                    <div>‚ùå Hindari: Gorengan, minuman manis, nasi putih berlebih</div>
                </div>
                <p>üí™ Kombinasikan dengan olahraga kardio 3-4x seminggu!</p>
            `;
        }

        function getSurplusAdvice() {
            return `
                <p>üìà <strong>Tips Diet Surplus Kalori (Bulking):</strong></p>
                <div class="food-recommendation">
                    <strong>Prinsip Utama:</strong>
                    <div>‚Ä¢ Tambah 300-500 kkal dari TDEE</div>
                    <div>‚Ä¢ Protein: 1.6-2g per kg berat badan</div>
                    <div>‚Ä¢ Karbohidrat kompleks untuk energi</div>
                    <div>‚Ä¢ Lemak sehat dari alpukat, kacang</div>
                </div>
                <div class="food-recommendation">
                    <strong>Makanan yang Disarankan:</strong>
                    <div>‚úÖ Nasi, kentang, oatmeal (karbo kompleks)</div>
                    <div>‚úÖ Daging ayam, ikan, telur (protein)</div>
                    <div>‚úÖ Tempe, tahu (protein nabati)</div>
                    <div>‚úÖ Alpukat, kacang (lemak sehat)</div>
                    <div>‚úÖ Susu, pisang (snack berkalori)</div>
                </div>
                <p>üèãÔ∏è Kombinasikan dengan strength training 4-5x seminggu!</p>
            `;
        }

        function getProteinFoods() {
            const highProteinFoods = foodDatabase
                .filter(f => f.protein > 10)
                .sort((a, b) => b.protein - a.protein);
            
            let response = `<p>ü•© <strong>Makanan Tinggi Protein:</strong></p>`;
            
            highProteinFoods.forEach(food => {
                response += `
                    <div class="food-recommendation">
                        <strong>${food.name}</strong>
                        <div>üí™ Protein: ${food.protein}g | üî• ${food.calories} kkal per ${food.portion}</div>
                    </div>
                `;
            });
            
            response += `<p>üí° Protein penting untuk pembentukan otot dan pemulihan!</p>`;
            return response;
        }

        function getHealthySnacks() {
            return `
                <p>üçé <strong>Cemilan Sehat Rekomendasi:</strong></p>
                <div class="food-recommendation">
                    <strong>Cemilan Rendah Kalori:</strong>
                    <div>‚Ä¢ Buah-buahan segar (100 kkal)</div>
                    <div>‚Ä¢ Edamame rebus (120 kkal)</div>
                    <div>‚Ä¢ Yogurt plain (150 kkal)</div>
                    <div>‚Ä¢ Kacang almond 10 biji (70 kkal)</div>
                </div>
                <div class="food-recommendation">
                    <strong>Cemilan Berprotein:</strong>
                    <div>‚Ä¢ Telur rebus (70 kkal)</div>
                    <div>‚Ä¢ Tahu kukus (76 kkal)</div>
                    <div>‚Ä¢ Tempe goreng kering (192 kkal)</div>
                </div>
                <p>üí° Cemilan sebaiknya 10-15% dari total kalori harian!</p>
            `;
        }

        function getDefaultResponse() {
            return `
                <p>Maaf, saya kurang mengerti pertanyaan Anda. Saya bisa membantu dengan:</p>
                <button class="quick-reply-btn" onclick="sendQuickReply('Berapa kalori nasi goreng?')">Hitung kalori makanan</button>
                <button class="quick-reply-btn" onclick="sendQuickReply('Rekomendasi makanan deficit')">Rekomendasi makanan</button>
                <button class="quick-reply-btn" onclick="sendQuickReply('Menu sarapan sehat')">Menu harian</button>
                <button class="quick-reply-btn" onclick="sendQuickReply('Makanan tinggi protein')">Info nutrisi</button>
                <button class="quick-reply-btn" onclick="showImageUploadModal()">
                    <i class="fas fa-upload"></i> Upload File
                </button>
            `;
        }

        function addFoodFromChat(name, calories, protein, carbs, fat) {
            foodLog.push({
                name,
                calories,
                protein,
                carbs,
                fat,
                time: new Date().toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' })
            });
            saveData();
            updateDashboard();
            showToast(`${name} berhasil ditambahkan ke log!`);
            
            // Update chat with confirmation
            const chatContainer = document.getElementById('chatContainer');
            const botMessageDiv = document.createElement('div');
            botMessageDiv.className = 'chat-message bot-message';
            botMessageDiv.innerHTML = `
                <div class="message-avatar">ü§ñ</div>
                <div class="message-content">
                    <strong>NutriBot</strong>
                    <p>‚úÖ <strong>${name}</strong> telah ditambahkan ke log harian Anda!</p>
                    <p>Waktu: ${new Date().toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' })}</p>
                    <button class="quick-reply-btn" onclick="showDashboard()">
                        üìä Lihat Dashboard
                    </button>
                </div>
            `;
            chatContainer.appendChild(botMessageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // ========== UPLOAD FUNCTIONALITIES ==========

        function showImageUploadModal() {
            const modal = new bootstrap.Modal(document.getElementById('uploadModal'));
            modal.show();
            
            // Reset modal
            document.getElementById('previewContainer').classList.add('d-none');
            document.getElementById('filePreview').innerHTML = '';
            document.getElementById('uploadBtn').disabled = true;
            
            // Setup drag and drop
            setupDragAndDrop();
        }

        function showDocumentUpload() {
            showImageUploadModal();
            document.getElementById('analysisType').value = 'label';
        }

        function setupDragAndDrop() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');
            
            uploadArea.addEventListener('click', () => fileInput.click());
            
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = '#8B5CF6';
                uploadArea.style.background = 'rgba(139, 92, 246, 0.1)';
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.style.borderColor = '#06B6D4';
                uploadArea.style.background = '';
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = '#06B6D4';
                uploadArea.style.background = '';
                
                if (e.dataTransfer.files.length) {
                    fileInput.files = e.dataTransfer.files;
                    previewFile(e.dataTransfer.files[0]);
                }
            });
            
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length) {
                    previewFile(e.target.files[0]);
                }
            });
        }

        function previewFile(file) {
            if (!file) return;
            
            // Check file size (max 5MB)
            if (file.size > 5 * 1024 * 1024) {
                alert('File terlalu besar! Maksimum 5MB.');
                return;
            }
            
            const previewContainer = document.getElementById('previewContainer');
            const filePreview = document.getElementById('filePreview');
            
            previewContainer.classList.remove('d-none');
            
            if (file.type.startsWith('image/')) {
                // Preview image
                const reader = new FileReader();
                reader.onload = (e) => {
                    filePreview.innerHTML = `
                        <div class="text-center">
                            <img src="${e.target.result}" 
                                 style="max-width: 200px; max-height: 150px; border-radius: 8px; border: 2px solid #06B6D4;">
                            <p class="mt-2 mb-0"><strong>${file.name}</strong></p>
                            <p class="text-muted small">${(file.size / 1024).toFixed(2)} KB</p>
                        </div>
                    `;
                };
                reader.readAsDataURL(file);
            } else {
                // Preview document
                filePreview.innerHTML = `
                    <div class="text-center">
                        <i class="fas fa-file-alt" style="font-size: 48px; color: #8B5CF6;"></i>
                        <p class="mt-2 mb-0"><strong>${file.name}</strong></p>
                        <p class="text-muted small">${(file.size / 1024).toFixed(2)} KB - ${file.type}</p>
                    </div>
                `;
            }
            
            document.getElementById('uploadBtn').disabled = false;
        }

        async function processUploadedFile() {
            const fileInput = document.getElementById('fileInput');
            const analysisType = document.getElementById('analysisType').value;
            const description = document.getElementById('fileDescription').value;
            
            if (!fileInput.files.length) {
                alert('Pilih file terlebih dahulu!');
                return;
            }
            
            const file = fileInput.files[0];
            const uploadBtn = document.getElementById('uploadBtn');
            
            // Show loading
            uploadBtn.disabled = true;
            uploadBtn.querySelector('i').classList.remove('d-none');
            
            try {
                // Simulate processing delay
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // Determine which chat container to use
                let chatContainer;
                let isWelcomeChat = false;
                
                if (currentChatType === 'welcome' || document.getElementById('welcomeChatbotModal').classList.contains('show')) {
                    chatContainer = document.getElementById('welcomeChatContainer');
                    isWelcomeChat = true;
                } else {
                    chatContainer = document.getElementById('chatContainer');
                }
                
                // Add user message with file info
                const userMessageDiv = document.createElement('div');
                userMessageDiv.className = 'chat-message user-message';
                userMessageDiv.innerHTML = `
                    <div class="message-avatar">${isWelcomeChat ? 'üë§' : (userData.name ? userData.name.charAt(0) : 'üë§')}</div>
                    <div class="message-content">
                        <strong>${isWelcomeChat ? 'Anda' : (userData.name || 'Anda')}</strong>
                        <p>üìé <strong>${file.name}</strong></p>
                        ${description ? `<p><em>"${description}"</em></p>` : ''}
                        <small class="text-muted">${file.type.startsWith('image/') ? 'üñºÔ∏è Gambar' : 'üìÑ Dokumen'} - ${analysisType}</small>
                    </div>
                `;
                chatContainer.appendChild(userMessageDiv);
                
                // Process based on file type and analysis type
                const response = await analyzeUploadedFile(file, analysisType, description);
                
                // Add bot response
                const botMessageDiv = document.createElement('div');
                botMessageDiv.className = 'chat-message bot-message';
                botMessageDiv.innerHTML = `
                    <div class="message-avatar">ü§ñ</div>
                    <div class="message-content">
                        <strong>NutriBot</strong>
                        ${response}
                    </div>
                `;
                
                chatContainer.appendChild(botMessageDiv);
                chatContainer.scrollTop = chatContainer.scrollHeight;
                
                // Add to chat history
                chatHistory.push({
                    type: 'file',
                    fileName: file.name,
                    analysisType: analysisType,
                    description: description,
                    response: response
                });
                
                // Close modal
                bootstrap.Modal.getInstance(document.getElementById('uploadModal')).hide();
                
            } catch (error) {
                console.error('Upload error:', error);
                alert('Terjadi kesalahan saat memproses file.');
            } finally {
                // Reset button
                uploadBtn.disabled = false;
                uploadBtn.querySelector('i').classList.add('d-none');
                
                // Reset form
                document.getElementById('fileInput').value = '';
                document.getElementById('fileDescription').value = '';
                document.getElementById('previewContainer').classList.add('d-none');
            }
        }

        async function analyzeUploadedFile(file, analysisType, description) {
            // Simulate AI analysis
            const fileType = file.type;
            
            if (fileType.startsWith('image/')) {
                return analyzeImageFile(file, analysisType, description);
            } else {
                return analyzeDocumentFile(file, analysisType, description);
            }
        }

        function analyzeImageFile(file, analysisType, description) {
            // Mock AI analysis for image
            const mockResponses = {
                'nutrition': `
                    <p>üîç <strong>Analisis Gambar Makanan:</strong></p>
                    <div class="food-recommendation">
                        <p>Berdasarkan analisis gambar, saya mendeteksi:</p>
                        <div>üçö <strong>Karbohidrat:</strong> Nasi putih (perkiraan 200g) - 400 kkal</div>
                        <div>üçó <strong>Protein:</strong> Ayam goreng (1 potong) - 250 kkal</div>
                        <div>ü•ó <strong>Sayuran:</strong> Sayur tumis - 80 kkal</div>
                        <div>üî• <strong>Total Perkiraan:</strong> ~730 kkal</div>
                    </div>
                    <p>üí° <strong>Tips:</strong> Kombinasi yang baik! Pastikan tambahkan sumber lemak sehat seperti alpukat.</p>
                    <button class="quick-reply-btn" onclick="addMockFoodFromImage()">
                        ‚ûï Tambahkan ke Log Harian
                    </button>
                `,
                'label': `
                    <p>üìä <strong>Analisis Label Makanan:</strong></p>
                    <div class="food-recommendation">
                        <p>Saya membaca label nutrisi dari gambar:</p>
                        <div>üî• <strong>Kalori:</strong> 350 kkal per sajian</div>
                        <div>ü•© <strong>Protein:</strong> 15g per sajian</div>
                        <div>üçö <strong>Karbohidrat:</strong> 45g per sajian</div>
                        <div>ü•ë <strong>Lemak:</strong> 12g per sajian</div>
                    </div>
                    <p>üìù <strong>Rekomendasi:</strong> Produk ini memiliki kandungan gula yang cukup tinggi. Konsumsi dalam batas wajar.</p>
                `,
                'recipe': `
                    <p>üìã <strong>Analisis Resep:</strong></p>
                    <div class="food-recommendation">
                        <p>Resep terdeteksi: <strong>Nasi Goreng Seafood</strong></p>
                        <div>üç§ <strong>Bahan utama:</strong> Udang, cumi, nasi, telur, sayuran</div>
                        <div>‚öñÔ∏è <strong>Porsi:</strong> 4 orang</div>
                        <div>üî• <strong>Kalori per porsi:</strong> ~450 kkal</div>
                    </div>
                    <p>üí° <strong>Saran:</strong> Kurangi minyak goreng untuk versi yang lebih sehat. Gunakan minyak zaitun.</p>
                `,
                'general': `
                    <p>üì∏ <strong>Analisis Gambar Umum:</strong></p>
                    <div class="food-recommendation">
                        <p>Gambar menunjukkan makanan sehat dengan komposisi:</p>
                        <div>ü•ó <strong>Sayuran:</strong> 40% (wortel, brokoli, paprika)</div>
                        <div>üçó <strong>Protein:</strong> 30% (ayam panggang)</div>
                        <div>üçö <strong>Karbohidrat:</strong> 30% (nasi merah)</div>
                    </div>
                    <p>‚úÖ <strong>Kesimpulan:</strong> Komposisi nutrisi yang seimbang! Pertahankan pola makan seperti ini.</p>
                `
            };
            
            return mockResponses[analysisType] || mockResponses['general'];
        }

        function analyzeDocumentFile(file, analysisType, description) {
            // Mock AI analysis for document
            const mockResponses = {
                'label': `
                    <p>üìÑ <strong>Analisis Dokumen Label Nutrisi:</strong></p>
                    <div class="food-recommendation">
                        <p><strong>Ringkasan Nutrisi:</strong></p>
                        <div>üè∑Ô∏è <strong>Produk:</strong> Susu Almond Organik</div>
                        <div>üìä <strong>Ukuran sajian:</strong> 250ml</div>
                        <div>üî• <strong>Energi:</strong> 120 kkal</div>
                        <div>ü•© <strong>Protein:</strong> 3g</div>
                        <div>üçö <strong>Karbohidrat:</strong> 15g (Gula: 8g)</div>
                        <div>ü•ë <strong>Lemak:</strong> 5g (Jenuh: 0.5g)</div>
                    </div>
                    <p>‚úÖ <strong>Rekomendasi:</strong> Produk rendah lemak jenuh, cocok untuk diet. Perhatikan kandungan gula tambahan.</p>
                `,
                'recipe': `
                    <p>üìã <strong>Analisis Dokumen Resep:</strong></p>
                    <div class="food-recommendation">
                        <p><strong>Resep: Smoothie Bowl Berry</strong></p>
                        <div>ü•£ <strong>Bahan:</strong> Pisang, berry mix, yogurt Greek, granola, madu</div>
                        <div>‚öñÔ∏è <strong>Untuk:</strong> 2 porsi</div>
                        <div>üî• <strong>Nutrisi per porsi:</strong></div>
                        <div>&nbsp;&nbsp;‚Ä¢ Kalori: 280 kkal</div>
                        <div>&nbsp;&nbsp;‚Ä¢ Protein: 12g</div>
                        <div>&nbsp;&nbsp;‚Ä¢ Karbo: 45g</div>
                        <div>&nbsp;&nbsp;‚Ä¢ Lemak: 6g</div>
                    </div>
                    <p>üí° <strong>Saran:</strong> Resep sehat! Untuk protein lebih tinggi, tambahkan bubuk protein atau chia seeds.</p>
                `,
                'general': `
                    <p>üìÑ <strong>Analisis Dokumen:</strong></p>
                    <div class="food-recommendation">
                        <p>Dokumen berisi informasi nutrisi tentang:</p>
                        <div>üìà <strong>Pola Makan Mediterania</strong></div>
                        <div>ü•ó <strong>Fitur utama:</strong> Tinggi sayuran, buah, biji-bijian, ikan</div>
                        <div>‚ù§Ô∏è <strong>Manfaat:</strong> Kesehatan jantung, kontrol berat badan</div>
                        <div>üçΩÔ∏è <strong>Contoh menu harian:</strong> 2000-2500 kkal</div>
                    </div>
                    <p>‚úÖ <strong>Rekomendasi:</strong> Pola makan yang sangat direkomendasikan untuk kesehatan jangka panjang.</p>
                `
            };
            
            return mockResponses[analysisType] || mockResponses['general'];
        }

        function addMockFoodFromImage() {
            // Add a mock food from image analysis
            foodLog.push({
                name: "Makanan dari Gambar",
                calories: 730,
                protein: 35,
                carbs: 75,
                fat: 25,
                time: new Date().toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' })
            });
            saveData();
            updateDashboard();
            showToast("Makanan ditambahkan dari analisis gambar!");
            
            // Update chat with confirmation
            const chatContainer = document.getElementById('chatContainer');
            const botMessageDiv = document.createElement('div');
            botMessageDiv.className = 'chat-message bot-message';
            botMessageDiv.innerHTML = `
                <div class="message-avatar">ü§ñ</div>
                <div class="message-content">
                    <strong>NutriBot</strong>
                    <p>‚úÖ <strong>Makanan telah ditambahkan ke log harian!</strong></p>
                    <p>üî• 730 kkal | ü•© 35g protein | üçö 75g karbo | ü•ë 25g lemak</p>
                    <button class="quick-reply-btn" onclick="showDashboard()">
                        üìä Lihat Dashboard
                    </button>
                </div>
            `;
            chatContainer.appendChild(botMessageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // Enter key support for chat
        document.addEventListener('DOMContentLoaded', function() {
            // Chat input in chatbot page
            const chatInput = document.getElementById('chatInput');
            if (chatInput) {
                chatInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        sendMessage();
                    }
                });
            }
            
            // Chat input in welcome chatbot modal
            const welcomeChatInput = document.getElementById('welcomeChatInput');
            if (welcomeChatInput) {
                welcomeChatInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        sendWelcomeMessage();
                    }
                });
            }
            
            // File input description
            const fileDescription = document.getElementById('fileDescription');
            if (fileDescription) {
                fileDescription.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        processUploadedFile();
                    }
                });
            }
        });

        // Initialize upload area when modal shown
        document.getElementById('uploadModal').addEventListener('shown.bs.modal', function () {
            setupDragAndDrop();
        });
    </script>
</body>
</html>